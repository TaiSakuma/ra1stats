#!/usr/bin/env python

import common,workspace
import likelihoodSpec

def signal(i) :

    def scaled(t, factor) :
        return tuple([factor*item for item in t])

    lm1 = common.signal(xs = 4.9, label = "LM1 (LO)")
    lm1.insert("2010", {
            "effHad":  (0.0,    0.0,    0.02,   0.10),
            "effMuon": (0.0,    0.0,    0.002,  0.01)})
    lm1.insert("55", {
            "effHad":(0.0059, 0.0091, 0.0285, 0.0328, 0.0218, 0.0105, 0.0046, 0.0042),
            "effMuon":tuple([0.0]*8)})

    lm6 = common.signal(xs = 0.3104, label = "LM6 (LO)")
    lm6.insert("55", {
            "effHad": (0.0,     0.0,     0.005,   0.012,  0.019,  0.022,  0.018,  0.029),
            "effMuon":scaled((0.045, 0.045, 0.1568, 0.245, 0.3254, 0.3481, 0.2836, 0.3618), 1.0e-2)})
    lm6.insert("2010", { #mocked up from 2011
            "effHad": (0.0,     0.0,     0.005,   0.012 + 0.019 + 0.022 + 0.018 + 0.029),
            "effMuon":scaled((0.045, 0.045, 0.1568, 0.245 + 0.3254 + 0.3481 + 0.2836 + 0.3618), 1.0e-2)})

    p_29_25 = {"xs":5.4534794,
               "effMuon":[0.000146, 0.000833, 0.001835, 0.001565, 0.001366, 0.001371, 0.000196, 8.888631e-05],
               "effHad": [0.001417, 0.003229, 0.018751, 0.021711, 0.023040, 0.013011, 0.007199, 0.005279],
               "label":"m0= 280 GeV, m12=240 GeV (NLO)",
               }
    
    p_29_55 = {"xs":0.0413,
               "effMuon":[0.000426, 0.000596, 0.001506, 0.000771, 0.000939, 0.000613, 0.000846, 0.005793],
               "effHad": [0.003254, 0.003499, 0.004932, 0.005420, 0.007190, 0.010089, 0.014170, 0.073909],
               "label":"m0= 280 GeV, m12=540 GeV (NLO)"
               }

    p_181_19 = common.signal(xs = 5.6887135, label = "m_{0}=1800 GeV, m_{1/2}=180 GeV (NLO)")
    p_181_19.insert("55", {
            "effMuon":[0.000147, 0.000000, 0.000441, 0.000588, 0.000147, 0.000147, 0.000147, 0.000000],
            "effHad": [0.000231, 0.001030, 0.003325, 0.003974, 0.001766, 0.000588, 0.000000, 0.000000]})
    p_181_19.insert("2010", { #mocked up from 2011
            "effMuon":[0.000147, 0.000000, 0.000441, 0.000588 + 0.000147 + 0.000147 + 0.000147 + 0.000000],
            "effHad": [0.000231, 0.001030, 0.003325, 0.003974 + 0.001766 + 0.000588 + 0.000000 + 0.000000]})

    p_181_19.insert("55", {
            "effHad": [0.000609, 0.001324, 0.003472, 0.004121, 0.001766, 0.001030, 0.000000, 0.000147],
            "effMuon":[0.000231, 0.000000, 0.000441, 0.000588, 0.000147, 0.000147, 0.000000, 0.000000]})

    p_181_19.insert("52", {
            "effHad": [0.000000, 0.000294, 0.001030, 0.001324, 0.001471, 0.000588, 0.001030, 0.001117],
            "effMuon":[0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000]})

    p_181_19.insert("53", {
            "effHad": [0.000147, 0.000147, 0.001556, 0.002796, 0.001913, 0.000588, 0.000883, 0.000301],
            "effMuon":[0.000000, 0.000000, 0.000000, 0.000294, 0.000000, 0.000000, 0.000147, 0.000000]})

    p_181_29b = common.signal(xs = 0.6430277062, label = "m_{0}=1800 GeV, m_{1/2}=280 GeV (NLO, >=1btag)")
    p_181_29b.insert("55b_after", {
            "effHad": [0.000271, 0.000000, 0.000765, 0.000605, 0.001009, 0.000707, 0.000807, 0.001211],
            "effMuon":[0.000000, 0.000292, 9.05e-05, 0.000292, 0.000000, 0.000201, 0.000000, 0.000000]})

    p_181_29 = common.signal(xs = 0.6430277062, label = "m_{0}=1800 GeV, m_{1/2}=280 GeV (NLO)")
    p_181_29.insert("55", {
            "effHad": [0.001630, 0.000473, 0.001420, 0.001079, 0.002310, 0.001313, 0.001211, 0.001595],
            "effMuon":[9.05e-05, 0.000382, 0.000473, 0.000382, 0.000292, 0.000909, 0.000000, 0.000000]})
            
    p_181_29.insert("52", {
            "effHad": [0.000362, 9.05e-05, 0.000654, 0.000181, 0.000506, 0.000201, 0.001211, 0.002422],
            "effMuon":[0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000201]})

    p_181_29.insert("53", {
            "effHad": [0.000835, 9.05e-05, 0.000362, 0.000403, 0.001192, 0.001009, 0.001009, 0.001080],
            "effMuon":[0.000000, 0.000000, 0.000000, 0.000000, 0.000201, 0.000201, 0.000000, 0.000000]})
    
    filips_point1 = {'xs': 0.0909,
                     'effMuon': [0.0003, 0.0003, 0.0004, 0.0007, 0.0012, 0.0011, 0.0015, 0.0032],
                     'effHad':  [0.0015, 0.0014, 0.0043, 0.0043, 0.0067, 0.0091, 0.0115, 0.0392],
                     "label": "m0=540 GeV, m12=440 GeV",
                     }
    
    filips_point2 = {"xs":0.0962,
                     "effMuon":[0.0002, 0.0002, 0.0005, 0.0007, 0.0013, 0.0011, 0.0016, 0.0037],
                     "effHad":[0.0014, 0.0017, 0.0026, 0.0054, 0.0084, 0.0107, 0.0153, 0.0451],
                     "label":"m_{0} = 500 GeV;  m_{1/2} = 440 GeV",
                     }
    
    sue_anns_point = {'xs': 2004.,
                      'effMuon': [0.0, 0.0, 9.99e-05, 0.0, 9.99-05, 0.0, 0.0, 0.0],
                      'effHad': [0.0009, 0.0006, 0.0009, 0.0003, 0.0003, 9.99e-05, 0.0, 0.0],
                      "label": "m0=100 GeV, m12=100 GeV",
                      }
    
    t1_600_100 = {"xs":1.0,
                  "effMuon":[0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0],
                  "effHad":[0.0016, 0.0033, 0.0142, 0.0283, 0.0341, 0.0210, 0.0099, 0.0075],
                  "label":"T1 m_{gluino} = 600 GeV, m_{LSP} = 100 GeV, xs = 1.0 pb",
                  }
    
    t2_39_7 = {"xs":1.0,
               "effMuon":[0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0],
               "effHad":[0.0006, 0.0015, 0.0058, 0.0129, 0.0252, 0.0399, 0.0494, 0.2123],
               "label":"T2 39 7, xs = 1.0 pb",
               }
    
    broken = {
        "nEventsHad":328.0,
        "nEventsIn":10000.0,
        "effHadSumUncRelMcStats":0.0552157630374,
        "effMuonSum":0.0,
        "effHadSum":0.0328,
        "effMuon":[0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0],
        "effHad":[0.0159, 0.0089, 0.0058, 0.0017, 0.0003, 0.0002, 0.0, 0.0],
        "nEventsMuon":0.0,
        "xs":1.0,
        }
    
    return [{}, p_29_25, p_29_55, p_181_19, p_181_29, p_181_29b, lm6, t1_600_100, t2_39_7, broken][i]

f = workspace.foo(likelihoodSpec = likelihoodSpec.spec(),
                  #signal = signal(3),
                  signalExampleToStack = signal(5),
                  #trace = True
                  #rhoSignalMin = 0.1,
                  #extraSigEffUncSources = ["effHadSumUncRelMcStats"],
                  )

cl = 0.95 if not f.likelihoodSpec["qcdSearch"] else 0.68
#out = f.interval(cl = cl, method = ["profileLikelihood", "feldmanCousins"][0], makePlots = True); print out
#out = f.cls(cl = cl, plusMinus = {"OneSigma": 1.0, "TwoSigma": 2.0},makePlots = True,
#            calculatorType = ["frequentist", "asymptotic"][1],
#            testStatType = 3, nToys = 20, nWorkers = 1); print out
#f.profile()
f.bestFit(printValues = True)
#f.bestFit(drawMc = False, printValues = True)
#f.bestFit(printPages = True)
#f.qcdPlot()
#f.pValue(nToys = 300)
#f.ensemble(nToys = 1000)
#print f.clsCustom(nToys = 500, testStatType = 1)
#f.expectedLimit(cl = 0.95, nToys = 300, plusMinus = {"OneSigma": 1.0, "TwoSigma": 2.0}, makePlots = True)
#f.debug()
